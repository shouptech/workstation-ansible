---
# Tasks to be done as root
- hosts: localhost
  vars:
    ansible_become: true
    ansible_become_method: sudo
    ansible_become_user: root
    yakyak_destination: /opt/yakyak-linux-x64
    yakyak_url: https://github.com/yakyak/yakyak/releases/download/v1.4.3/yakyak-1.4.3-linux-x64.tar.gz
  handlers:
    - name: config NetworkManger.conf for default dns
      lineinfile:
        dest: /etc/NetworkManager/NetworkManager.conf
        line: dns=default
        insertafter: '\[main\]'
      listen: enable default dns
    - name: remove resolv.conf
      file:
        dest: /etc/resolv.conf
        state: absent
      listen: enable default dns
    - name: restart network-manager
      systemd:
        name: network-manager
        state: restarted
      listen: enable default dns
    - name: wait for dns
      wait_for:
        host: google.com
        port: 80
        timeout: 60
      listen: enable default dns
  tasks:
    - name: disable systemd-resolved service
      systemd:
        name: systemd-resolved
        state: stopped
        enabled: false
      notify:
        - enable default dns
    - name: flush handlers
      meta: flush_handlers
    - name: allow nopasswd sudo
      lineinfile:
        dest: /etc/sudoers
        regexp: '^%sudo'
        line: '%sudo ALL=(ALL) NOPASSWD: ALL'
        validate: '/usr/sbin/visudo -cf %s'
    - name: apt keys
      tags: packages
      apt_key:
        url: "{{ item }}"
        state: present
      with_items:
        - https://www.virtualbox.org/download/oracle_vbox_2016.asc
        - https://www.virtualbox.org/download/oracle_vbox.asc
    - name: dropbox apt key
      tags: packages
      apt_key:
        id: 1C61A2656FB57B7E4DE0F4C1FC918B335044912E
        keyserver: pgp.mit.edu
    - name: apt repositories
      tags: packages
      apt_repository:
        repo: "{{ item }}"
        update_cache: false
      with_items:
        - 'ppa:nextcloud-devs/client'
        - 'ppa:webupd8team/atom'
        - deb http://download.virtualbox.org/virtualbox/debian zesty contrib
        - deb http://linux.dropbox.com/ubuntu xenial main
    - name: update apt cache
      tags: packages
      apt:
        update_cache: true
      changed_when: false
    - name: workstation packages
      tags: packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - vim
        - ansible
        - terminator
        - atom
        - zsh
        - nextcloud-client
        - fonts-hack-web
        - gnome-shell-extension-appindicator # Adds tray icons, still needs to be enabled
        - network-manager-openconnect
        - network-manager-openconnect-gnome
        - network-manager-l2tp
        - network-manager-l2tp-gnome
        - network-manager-openvpn
        - network-manager-openvpn-gnome
        - virtualbox-5.2
        - dkms
        - mesa-utils
        - whois
        - remmina
        - remmina-plugin-rdp
        - remmina-plugin-gnome
        - freerdp-x11
        - dropbox
        - gnome-tweak-tool
        - default-jre
        - keepass2
        - virtualenv
        - gstreamer1.0-libav
        - docker.io
        - evolution
        - evolution-ews
        - qemu-kvm
        - libvirt-bin
        - ubuntu-vm-builder
        - bridge-utils
        - virt-manager
    - name: check mattermost package
      tags: packages
      shell: dpkg-query -l mattermost-desktop
      register: mattermost
      failed_when: false
      changed_when: false
    - name: mattermost package
      tags: packages
      apt:
        deb: https://releases.mattermost.com/desktop/3.7.1/mattermost-desktop-3.7.1-linux-amd64.deb
      when: mattermost.rc != 0
    - name: local user shell
      user:
        name: "{{ ansible_env.USER }}"
        shell: /usr/bin/zsh
    - name: check yakyak directory
      stat:
        path: "{{ yakyak_destination }}"
      register: yakyak_installed
    - name: untar yakyak
      unarchive:
        src: "{{ yakyak_url }}"
        dest: /opt
        remote_src: true
      when: not yakyak_installed.stat.exists
    - name: symlink yakyak bin
      file:
        src: /opt/yakyak-linux-x64/yakyak
        dest: /usr/local/bin/yakyak
        state: link
    - name: yakyak desktop icon
      copy:
        src: files/YakYak.desktop
        dest: /usr/share/applications/YakYak.desktop

# Tasks to be done as "{{ ansible_env.USER }}"
- hosts: localhost
  vars:
    ansible_become: false
  tasks:
    - name: copy vimrc
      copy:
        src: files/vimrc
        dest: "{{ ansible_env.HOME }}/.vimrc"
    - name: copy terminator config
      copy:
        src: files/terminator
        dest: "{{ ansible_env.HOME }}/.config"
    - name: install oh-my-zsh
      git:
        repo: git://github.com/robbyrussell/oh-my-zsh.git
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh"
    - name: copy zshrc
      template:
        src: files/zshrc.j2
        dest: "{{ ansible_env.HOME }}/.zshrc"
    - name: oh-my-zsh custom theme directory
      file:
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes"
        state: directory
    - name: copy custom theme
      copy:
        src: files/gentoo-mod.zsh-theme
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes"
